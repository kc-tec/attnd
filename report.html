<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Report</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- NEW: SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style for table */
        table thead th { position: sticky; top: 0; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Attendance Report</h1>

        <!-- Loading / Auth Section -->
        <div id="loading-container" class="text-center py-8">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-3 font-medium text-gray-600">Connecting to service...</p>
        </div>

        <!-- Main Report UI (hidden by default) -->
        <div id="report-container" class="hidden">
            <!-- Filters -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <input type="text" id="filter-class" placeholder="Filter by Class..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="filter-student-id" placeholder="Filter by Student ID..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="filter-course" placeholder="Filter by Course..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 mb-6">
                <button id="fetch-reports-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300">
                    Fetch All Reports
                </button>
                <button id="download-csv-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as CSV
                </button>
                <!-- NEW BUTTONS -->
                <button id="download-excel-btn" class="w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as Excel
                </button>
                <button id="download-pdf-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as PDF
                </button>
            </div>
            
            <p id="report-status" class="text-center text-gray-600 mb-4"></p>

            <!-- Report Table -->
            <div class="max-h-[600px] overflow-y-auto border border-gray-200 rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student Name</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student ID</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Class</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Course</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Teacher</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Distance (m)</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="no-results" class="text-center text-gray-500 py-8 hidden">No reports found.</p>

        </div>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoQStCXGXMe5Bz5hk14cOmynRI3gPGs6o",
            authDomain: "kcpttc.firebaseapp.com",
            projectId: "kcpttc",
            storageBucket: "kcpttc.firebasestorage.app",
            messagingSenderId: "709003234625",
            appId: "1:709003234625:web:c9284048369530895065c0",
            measurementId: "G-P1NN0RSNFW"
        };
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : firebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        // --- Initialize Firebase ---
        let app, auth, db;
        try {
            app = initializeApp(finalFirebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.getElementById("loading-text").textContent = "Error: Could not connect to Firebase.";
        }

        // --- UI Elements ---
        const loadingContainer = document.getElementById("loading-container");
        const loadingText = document.getElementById("loading-text");
        const reportContainer = document.getElementById("report-container");
        const fetchBtn = document.getElementById("fetch-reports-btn");
        const downloadBtn = document.getElementById("download-csv-btn");
        const tableBody = document.getElementById("report-table-body");
        const noResults = document.getElementById("no-results");
        const reportStatus = document.getElementById("report-status");

        const filterClass = document.getElementById("filter-class");
        const filterStudentId = document.getElementById("filter-student-id");
        const filterCourse = document.getElementById("filter-course");

        // --- NEW ---
        const downloadExcelBtn = document.getElementById("download-excel-btn");
        const downloadPdfBtn = document.getElementById("download-pdf-btn");
        // --- END NEW ---

        let allReportData = []; // To store fetched data

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    // Try to sign in with token or anonymously, just to get auth
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Authenticated for reporting.");
                } catch (error) {
                    console.error("Auth error:", error);
                    loadingText.textContent = "Authentication failed. You must be signed in to view reports.";
                    return;
                }
            }
            // User is authenticated
            loadingContainer.classList.add("hidden");
            reportContainer.classList.remove("hidden");
        });

        // --- Event Listeners ---
        fetchBtn.addEventListener("click", fetchReports);
        downloadBtn.addEventListener("click", downloadCSV);
        
        // --- NEW ---
        downloadExcelBtn.addEventListener("click", downloadExcel);
        downloadPdfBtn.addEventListener("click", downloadPDF);
        // --- END NEW ---

        // Add listeners for filters
        [filterClass, filterStudentId, filterCourse].forEach(input => {
            input.addEventListener('input', applyFilters);
        });

        /**
         * Fetches all logs from the 'master_log' collection.
         */
        async function fetchReports() {
            fetchBtn.disabled = true;
            fetchBtn.textContent = "Fetching...";
            reportStatus.textContent = "Loading data from Firestore...";
            noResults.classList.add("hidden");

            try {
                const logPath = `artifacts/${appId}/public/data/master_log`;
                const q = query(collection(db, logPath));
                
                const querySnapshot = await getDocs(q);
                
                allReportData = querySnapshot.docs.map(doc => doc.data());
                
                // Sort by timestamp (newest first)
                allReportData.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });

                if (allReportData.length > 0) {
                    applyFilters(); // Display the data
                    downloadBtn.classList.remove("hidden");
                    downloadExcelBtn.classList.remove("hidden"); // NEW
                    downloadPdfBtn.classList.remove("hidden"); // NEW
                    reportStatus.textContent = `Fetched ${allReportData.length} total records.`;
                } else {
                    tableBody.innerHTML = ""; // Clear table
                    noResults.classList.remove("hidden");
                    downloadBtn.classList.add("hidden");
                    downloadExcelBtn.classList.add("hidden"); // NEW
                    downloadPdfBtn.classList.add("hidden"); // NEW
                    reportStatus.textContent = "No records found.";
                }

            } catch (error) {
                console.error("Error fetching reports:", error);
                reportStatus.textContent = `Error fetching reports: ${error.message}`;
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = "Fetch All Reports";
            }
        }

        /**
         * Applies the current filters to the 'allReportData' and updates the table.
         */
        function applyFilters() {
            const classFilter = filterClass.value.toLowerCase();
            const idFilter = filterStudentId.value.toLowerCase();
            const courseFilter = filterCourse.value.toLowerCase();

            const filteredData = allReportData.filter(log => {
                const logClass = (log.class || "").toLowerCase();
                const logStudentId = (log.studentId || "").toLowerCase();
                const logCourse = (log.course || "").toLowerCase();

                return logClass.includes(classFilter) &&
                       logStudentId.includes(idFilter) &&
                       logCourse.includes(courseFilter);
            });

            populateTable(filteredData);
        }

        /**
         * Populates the HTML table with filtered report data.
         */
        function populateTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = "";
                noResults.classList.remove("hidden");
                return;
            }

            noResults.classList.add("hidden");
            let tableHtml = "";

            data.forEach(log => {
                const timestamp = log.timestamp ? log.timestamp.toDate() : new Date(0);
                const dateStr = timestamp.toLocaleString('en-US', { 
                    dateStyle: 'short', 
                    timeStyle: 'short' 
                });
                
                const statusClass = log.isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = log.isSuccess ? 'Success' : 'Failed';

                tableHtml += `
                    <tr class="text-sm text-gray-700">
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 font-semibold leading-tight text-xs rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${dateStr}</td>
                        <td class="px-4 py-3 font-medium">${log.userName || 'N/A'}</td>
                        <td class="px-4 py-3">${log.studentId || 'N/A'}</td>
                        <td class="px-4 py-3">${log.class || 'N/A'}</td>
                        <td class="px-4 py-3">${log.course || 'N/A'}</td>
                        <td class="px-4 py-3">${log.teacher || 'N/A'}</td>
                        <td class="px-4 py-3">${log.reportedDistance != null ? Math.round(log.reportedDistance) : 'N/A'}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHtml;
        }

        /**
         * Converts the currently *filtered* data to CSV and triggers a download.
         */
        function downloadCSV() {
            // Get the currently filtered data
            const classFilter = filterClass.value.toLowerCase();
            const idFilter = filterStudentId.value.toLowerCase();
            const courseFilter = filterCourse.value.toLowerCase();

            const filteredData = allReportData.filter(log => {
                const logClass = (log.class || "").toLowerCase();
                const logStudentId = (log.studentId || "").toLowerCase();
                const logCourse = (log.course || "").toLowerCase();

                return logClass.includes(classFilter) &&
                       logStudentId.includes(idFilter) &&
                       logCourse.includes(courseFilter);
            });

            if (filteredData.length === 0) {
                alert("No data to download.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // CSV Headers
            const headers = [
                "Status", "Timestamp", "Student Name", "Student ID", "Class", "Course", "Teacher", 
                "Distance (m)", "Success", "User ID", "User Agent"
            ];
            csvContent += headers.join(",") + "\r\n";

            // CSV Rows
            filteredData.forEach(log => {
                const timestamp = log.timestamp ? log.timestamp.toDate().toISOString() : "";
                const row = [
                    log.isSuccess ? "Success" : "Failed",
                    timestamp,
                    `"${log.userName || ""}"`,
                    `"${log.studentId || ""}"`,
                    `"${log.class || ""}"`,
                    `"${log.course || ""}"`,
                    `"${log.teacher || ""}"`,
                    log.reportedDistance != null ? Math.round(log.reportedDistance) : "",
                    log.isSuccess,
                    `"${log.userId || ""}"`,
                    `"${log.userAgent || ""}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "attendance_report.csv");
            document.body.appendChild(link); // Required for Firefox

            link.click();
            document.body.removeChild(link);
        }

        // --- NEW FUNCTIONS ---

        /**
         * Converts the currently *filtered* data to an Excel (.xlsx) file and triggers a download.
         */
        function downloadExcel() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }

            // 1. Re-format data for the worksheet
            const worksheetData = data.map(log => ({
                Status: log.isSuccess ? "Success" : "Failed",
                Timestamp: log.timestamp ? log.timestamp.toDate() : "",
                "Student Name": log.userName || "",
                "Student ID": log.studentId || "",
                Class: log.class || "",
                Course: log.course || "",
                Teacher: log.teacher || "",
                "Distance (m)": log.reportedDistance != null ? Math.round(log.reportedDistance) : "",
                "User ID": log.userId || ""
            }));

            // 2. Create worksheet and workbook
            const ws = XLSX.utils.json_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");

            // 3. Auto-size columns (optional but nice)
            const cols = Object.keys(worksheetData[0]).map(key => ({
                wch: Math.max(key.length, ...worksheetData.map(row => String(row[key]).length))
            }));
            ws["!cols"] = cols;

            // 4. Trigger download
            XLSX.writeFile(wb, "attendance_report.xlsx");
        }

        /**
         * Converts the currently *filtered* data to a PDF file and triggers a download.
         */
        function downloadPDF() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }

            // 1. Initialize jsPDF
            // Note: jsPDF is loaded from the script tag, so we can use it here
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });

            // 2. Define Columns and Rows for autoTable
            const head = [['Status', 'Date', 'Name', 'Student ID', 'Class', 'Course', 'Distance (m)']];
            const body = data.map(log => [
                log.isSuccess ? 'Success' : 'Failed',
                log.timestamp ? log.timestamp.toDate().toLocaleString('en-US') : '',
                log.userName || '',
                log.studentId || '',
                log.class || '',
                log.course || '',
                log.reportedDistance != null ? Math.round(log.reportedDistance) : ''
            ]);

            // 3. Generate the table
            doc.autoTable({
                head: head,
                body: body,
                startY: 50,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [37, 99, 235] } // Blue header
            });

            // 4. Add a title
            doc.setFontSize(18);
            doc.text("Attendance Report", 40, 35);

            // 5. Trigger download
            doc.save('attendance_report.pdf');
        }

        /**
         * Helper function to get the currently filtered data.
         */
        function getFilteredData() {
            const classFilter = filterClass.value.toLowerCase();
            const idFilter = filterStudentId.value.toLowerCase();
            const courseFilter = filterCourse.value.toLowerCase();

            return allReportData.filter(log => {
                const logClass = (log.class || "").toLowerCase();
                const logStudentId = (log.studentId || "").toLowerCase();
                const logCourse = (log.course || "").toLowerCase();

                return logClass.includes(classFilter) &&
                       logStudentId.includes(idFilter) &&
                       logCourse.includes(courseFilter);
            });
        }
        // --- END NEW FUNCTIONS ---

    </script>
</body>
</html>