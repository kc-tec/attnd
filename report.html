<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Report</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style for table */
        table thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* gray-100 */
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Attendance Report</h1>

        <!-- Loading / Auth Section -->
        <div id="loading-container" class="text-center py-8">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-3 font-medium text-gray-600">Connecting to service...</p>
        </div>

        <!-- Main Report UI (hidden by default) -->
        <div id="report-container" class="hidden">
            <!-- Filters -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <input type="text" id="filter-name" placeholder="Filter by Name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="filter-class" placeholder="Filter by Class..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="filter-course" placeholder="Filter by Course..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button id="fetch-reports-btn" class="flex-grow sm:flex-grow-0 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300">
                    Fetch Reports
                </button>
                <button id="download-csv-btn" class="flex-grow sm:flex-grow-0 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as CSV
                </button>
                <button id="download-excel-btn" class="flex-grow sm:flex-grow-0 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as Excel
                </button>
                <button id="download-pdf-btn" class="flex-grow sm:flex-grow-0 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as PDF
                </button>
            </div>
            
            <p id="report-status" class="text-center text-gray-600 mb-4"></p>

            <!-- Report Table -->
            <div class="max-h-[600px] overflow-y-auto border border-gray-200 rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- *** TABLE HEAD MODIFIED *** -->
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Timestamp</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student Name</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Class</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Course</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Teacher</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="no-results" class="text-center text-gray-500 py-8 hidden">No reports found.</p>

            <!-- NEW Load More Button -->
            <div class="mt-6 text-center">
                <button id="load-more-btn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-lg transition duration-300">
                    Load More Reports
                </button>
            </div>

        </div>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** IMPORTS MODIFIED ***
        import { 
            getFirestore, collection, getDocs, query, 
            orderBy, limit, startAfter 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoQStCXGXMe5Bz5hk14cOmynRI3gPGs6o",
            authDomain: "kcpttc.firebaseapp.com",
            projectId: "kcpttc",
            storageBucket: "kcpttc.firebasestorage.app",
            messagingSenderId: "709003234625",
            appId: "1:709003234625:web:c9284048369530895065c0",
            measurementId: "G-P1NN0RSNFW"
        };
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : firebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        // --- Initialize Firebase ---
        let app, auth, db;
        let masterLogRef;
        try {
            app = initializeApp(finalFirebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Define the path to the master log
            const masterLogPath = `artifacts/${appId}/public/data/master_log`;
            masterLogRef = collection(db, masterLogPath);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.getElementById("loading-text").textContent = "Error: Could not connect to Firebase.";
        }

        // --- UI Elements ---
        const loadingContainer = document.getElementById("loading-container");
        const loadingText = document.getElementById("loading-text");
        const reportContainer = document.getElementById("report-container");
        const fetchBtn = document.getElementById("fetch-reports-btn");
        const loadMoreBtn = document.getElementById("load-more-btn"); // New button
        const downloadCsvBtn = document.getElementById("download-csv-btn");
        const downloadExcelBtn = document.getElementById("download-excel-btn");
        const downloadPdfBtn = document.getElementById("download-pdf-btn");
        const tableBody = document.getElementById("report-table-body");
        const noResults = document.getElementById("no-results");
        const reportStatus = document.getElementById("report-status");

        const filterName = document.getElementById("filter-name");
        const filterClass = document.getElementById("filter-class");
        const filterCourse = document.getElementById("filter-course");
        
        let allReportData = []; // To store all fetched log data
        let lastVisibleDoc = null; // To track pagination
        const REPORTS_PER_PAGE = 50; // Set page size

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    // Try to sign in with token or anonymously, just to get auth
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Authenticated for reporting.");
                } catch (error) {
                    console.error("Auth error:", error);
                    loadingText.textContent = "Authentication failed. You must be signed in to view reports.";
                    return;
                }
            }
            
            // User is authenticated
            loadingContainer.classList.add("hidden");
            reportContainer.classList.remove("hidden");
        });

        // --- Event Listeners ---
        fetchBtn.addEventListener("click", fetchInitialReports); // Changed
        loadMoreBtn.addEventListener("click", fetchMoreReports); // New
        downloadCsvBtn.addEventListener("click", downloadCSV);
        downloadExcelBtn.addEventListener("click", downloadExcel);
        downloadPdfBtn.addEventListener("click", downloadPDF);

        // Add listeners for filters
        [filterName, filterClass, filterCourse].forEach(input => {
            input.addEventListener('input', applyFilters);
        });

        /**
         * Fetches the *first* page of logs from the 'master_log' collection.
         */
        async function fetchInitialReports() {
            fetchBtn.disabled = true;
            fetchBtn.textContent = "Fetching...";
            reportStatus.textContent = "Loading reports from Firestore...";
            noResults.classList.add("hidden");
            loadMoreBtn.classList.add("hidden"); // Hide load more button
            
            // Clear all old data
            allReportData = [];
            lastVisibleDoc = null;
            tableBody.innerHTML = "";

            try {
                // Query for the first 50 reports, ordered by timestamp
                const q = query(masterLogRef, 
                                orderBy("timestamp", "desc"), 
                                limit(REPORTS_PER_PAGE));
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    noResults.classList.remove("hidden");
                    reportStatus.textContent = "No reports found.";
                    downloadCsvBtn.classList.add("hidden");
                    downloadExcelBtn.classList.add("hidden");
                    downloadPdfBtn.classList.add("hidden");
                    return;
                }

                // Store the last visible document for pagination
                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                allReportData = querySnapshot.docs.map(doc => doc.data());
                
                applyFilters(); // Display the data
                
                // Show download buttons
                downloadCsvBtn.classList.remove("hidden");
                downloadExcelBtn.classList.remove("hidden");
                downloadPdfBtn.classList.remove("hidden");
                
                // Show "Load More" button if we got a full page
                if (querySnapshot.size === REPORTS_PER_PAGE) {
                    loadMoreBtn.classList.remove("hidden");
                }
                
                reportStatus.textContent = `Fetched ${allReportData.length} reports.`;

            } catch (error) {
                console.error("Error fetching reports:", error);
                // --- THIS IS IMPORTANT ---
                // This error likely means you need to create a Firebase Index.
                // The error message in your browser console will have a link to create it.
                if (error.code === 'failed-precondition') {
                    reportStatus.innerHTML = `<strong>Error:</strong> Firestore index required. Please open the browser console (F12), find the error message, and click the link to create the index.`;
                } else {
                    reportStatus.textContent = `Error fetching reports: ${error.message}`;
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = "Fetch Reports";
            }
        }

        /**
         * Fetches the *next* page of reports.
         */
        async function fetchMoreReports() {
            if (!lastVisibleDoc) {
                console.log("No more documents to load.");
                loadMoreBtn.classList.add("hidden");
                return;
            }

            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = "Loading...";

            try {
                // Query for the next 50, starting *after* the last one we saw
                const q = query(masterLogRef, 
                                orderBy("timestamp", "desc"), 
                                startAfter(lastVisibleDoc),
                                limit(REPORTS_PER_PAGE));

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // No more documents found
                    lastVisibleDoc = null;
                    loadMoreBtn.classList.add("hidden");
                    reportStatus.textContent = `All ${allReportData.length} reports loaded.`;
                    return;
                }

                // Update the last visible doc
                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];

                // Add the new reports to our existing data
                const newReports = querySnapshot.docs.map(doc => doc.data());
                allReportData.push(...newReports);

                // Re-apply filters to the entire (now larger) dataset
                applyFilters();

                // Show "Load More" button if we got another full page
                if (querySnapshot.size < REPORTS_PER_PAGE) {
                    loadMoreBtn.classList.add("hidden"); // We've reached the end
                    reportStatus.textContent = `All ${allReportData.length} reports loaded.`;
                } else {
                    reportStatus.textContent = `Fetched ${allReportData.length} total reports.`;
                }

            } catch (error) {
                console.error("Error fetching more reports:", error);
                reportStatus.textContent = `Error: ${error.message}`;
            } finally {
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = "Load More Reports";
            }
        }

        /**
         * Applies the current filters to the 'allReportData' and updates the table.
         */
        function applyFilters() {
            const nameFilter = filterName.value.toLowerCase();
            const classFilter = filterClass.value.toLowerCase();
            const courseFilter = filterCourse.value.toLowerCase();

            const filteredData = getFilteredData(nameFilter, classFilter, courseFilter);
            populateTable(filteredData);
        }

        /**
         * Populates the HTML table with filtered log data.
         * This function now *replaces* the table body every time.
         */
        function populateTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = "";
                noResults.classList.remove("hidden");
                return;
            }

            noResults.classList.add("hidden");
            let tableHtml = "";

            data.forEach(log => {
                const timestamp = log.timestamp ? log.timestamp.toDate() : new Date(0);
                const dateStr = timestamp.toLocaleString('en-US', { 
                    dateStyle: 'short', 
                    timeStyle: 'short' 
                });
                
                // *** TABLE ROW MODIFIED ***
                tableHtml += `
                    <tr class="text-sm text-gray-700">
                        <td class="px-4 py-3 whitespace-nowrap">${dateStr}</td>
                        <td class="px-4 py-3">${escapeHTML(log.userName || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(log.class || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(log.course || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(log.teacher || 'N/A')}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHtml;
        }
        
        // --- Download/Export Functions ---

        /**
         * Converts the currently *filtered* data to CSV and triggers a download.
         */
        function downloadCSV() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // *** CSV HEADERS MODIFIED ***
            const headers = [
                "Timestamp", "Student Name", "Class", "Course", "Teacher", 
                "Latitude", "Longitude", "User Agent", "Status", "Distance (m)", "User ID"
            ];
            csvContent += headers.join(",") + "\r\n";

            // *** CSV ROWS MODIFIED ***
            data.forEach(log => {
                const timestamp = log.timestamp ? log.timestamp.toDate().toISOString() : "";
                const row = [
                    timestamp,
                    `"${log.userName || ""}"`,
                    `"${log.class || ""}"`,
                    `"${log.course || ""}"`,
                    `"${log.teacher || ""}"`,
                    log.reportedLat || "",
                    log.reportedLon || "",
                    `"${(log.userAgent || "").replace(/"/g, '""')}"`,
                    // Add back non-visible data for exports
                    log.isSuccess ? "Success" : "Failed",
                    log.reportedDistance ? log.reportedDistance.toFixed(2) : "",
                    `"${log.userId || ""}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "attendance_report.csv");
            document.body.appendChild(link); // Required for Firefox

            link.click();
            document.body.removeChild(link);
        }

        /**
         * Converts the currently *filtered* data to an Excel (.xlsx) file and triggers a download.
         */
        function downloadExcel() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }

            // *** WORKSHEET DATA MODIFIED ***
            // 1. Re-format data for the worksheet
            const worksheetData = data.map(log => ({
                "Timestamp": log.timestamp ? log.timestamp.toDate() : "",
                "Student Name": log.userName || "",
                "Class": log.class || "",
                "Course": log.course || "",
                "Teacher": log.teacher || "",
                // Add back non-visible data for exports
                "Status": log.isSuccess ? "Success" : "Failed",
                "Distance (m)": log.reportedDistance ? log.reportedDistance.toFixed(2) : "",
                "User ID": log.userId || "",
                "Latitude": log.reportedLat || "",
                "Longitude": log.reportedLon || "",
                "User Agent": log.userAgent || ""
            }));

            // 2. Create worksheet and workbook
            const ws = XLSX.utils.json_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");

            // 3. Auto-size columns (best guess)
            const cols = Object.keys(worksheetData[0]).map(key => ({
                wch: Math.max(key.length, ...worksheetData.map(row => String(row[key]).length))
            }));
            ws["!cols"] = cols;

            // 4. Trigger download
            XLSX.writeFile(wb, "attendance_report.xlsx");
        }

        /**
         * Converts the currently *filtered* data to a PDF file and triggers a download.
         */
        function downloadPDF() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });

            // *** PDF HEAD/BODY MODIFIED ***
            // Define Columns and Rows for autoTable
            const head = [['Timestamp', 'Student Name', 'Class', 'Course', 'Teacher']];
            const body = data.map(log => [
                log.timestamp ? log.timestamp.toDate().toLocaleString('en-US') : '',
                log.userName || '',
                log.class || '',
                log.course || '',
                log.teacher || ''
            ]);

            // Generate the table
            doc.autoTable({
                head: head,
                body: body,
                startY: 50,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [37, 99, 235] } // Blue header
            });

            // Add a title
            doc.setFontSize(18);
            doc.text("Attendance Report", 40, 35);

            // Trigger download
            doc.save('attendance_report.pdf');
        }

        /**
         * Helper function to get the currently filtered data based on all filters.
         */
        function getFilteredData(
            nameFilter = filterName.value.toLowerCase(),
            classFilter = filterClass.value.toLowerCase(),
            courseFilter = filterCourse.value.toLowerCase()
        ) {
            return allReportData.filter(log => {
                const logName = (log.userName || "").toLowerCase();
                const logClass = (log.class || "").toLowerCase();
                const logCourse = (log.course || "").toLowerCase();

                return logName.includes(nameFilter) &&
                       logClass.includes(classFilter) &&
                       logCourse.includes(courseFilter);
            });
        }
        
        /**
         * Simple HTML escaper to prevent XSS
         */
        function escapeHTML(str) {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

    </script>
</body>
</html>