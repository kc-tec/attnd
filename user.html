<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Report</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style for table */
        table thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* gray-100 */
            z-index: 10;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">User Report</h1>

        <!-- Loading / Auth Section -->
        <div id="loading-container" class="text-center py-8">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-3 font-medium text-gray-600">Connecting to service...</p>
        </div>

        <!-- Main Report UI (hidden by default) -->
        <div id="report-container" class="hidden">
            <!-- Filters -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <input type="text" id="filter-id" placeholder="Filter by Student ID..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="filter-name" placeholder="Filter by Name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="filter-class" placeholder="Filter by Class..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button id="fetch-users-btn" class="flex-grow sm:flex-grow-0 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300">
                    Fetch Users
                </button>
                <!-- NEW "Add User" Button -->
                <button id="add-user-btn" class="flex-grow sm:flex-grow-0 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300">
                    Add New User
                </button>
                <button id="download-csv-btn" class="flex-grow sm:flex-grow-0 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as CSV
                </button>
                <button id="download-excel-btn" class="flex-grow sm:flex-grow-0 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as Excel
                </button>
                <button id="download-pdf-btn" class="flex-grow sm:flex-grow-0 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 hidden">
                    Download as PDF
                </button>
            </div>
            
            <p id="report-status" class="text-center text-gray-600 mb-4"></p>

            <!-- User Table -->
            <div class="max-h-[600px] overflow-y-auto border border-gray-200 rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Student ID</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Class</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Phone</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="no-results" class="text-center text-gray-500 py-8 hidden">No users found.</p>

            <!-- NEW Load More Button -->
            <div class="mt-6 text-center">
                <button id="load-more-btn" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-lg transition duration-300">
                    Load More Users
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: User Form Modal (for Add/Edit) -->
    <div id="user-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-xl p-6 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Add New User</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            
            <form id="user-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <!-- User ID Field -->
                <div>
                    <label for="modal-uid" class="block text-sm font-medium text-gray-700 mb-1">User ID (UID)</label>
                    <input type="text" id="modal-uid" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Auto-generated or enter manually...">
                    <p class="text-xs text-gray-500 mt-1">For new users, you can enter the Firebase Auth UID. This field is read-only when editing.</p>
                </div>

                <div>
                    <label for="modal-student-id" class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                    <input type="text" id="modal-student-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 8031" required>
                </div>
                <div>
                    <label for="modal-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="modal-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Chenda Nary" required>
                </div>
                <div>
                    <label for="modal-sex" class="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                    <select id="modal-sex" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" required>
                        <option value="">Please select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div>
                    <label for="modal-tel" class="block text-sm font-medium text-gray-700 mb-1">Telephone</label>
                    <input type="tel" id="modal-tel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 012 345 678" required>
                </div>
                <div>
                    <label for="modal-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="modal-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., student.email@example.com" required>
                </div>
                <div>
                    <label for="modal-program" class="block text-sm font-medium text-gray-700 mb-1">Program</label>
                    <input type="text" id="modal-program" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 12+2" required>
                </div>
                <div>
                    <label for="modal-academic-year" class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                    <input type="text" id="modal-academic-year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Year 4" required>
                </div>
                <div>
                    <label for="modal-class" class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                    <input type="text" id="modal-class" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., A1" required>
                </div>
            </form>
            
            <div id="modal-message" class="text-sm text-center mt-4"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancel
                </button>
                <button id="save-user-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Save User
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Custom Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 transform -translate-y-10">
             <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete User?</h3>
             <p id="delete-confirm-text" class="text-sm text-gray-600 mb-6">Are you sure you want to delete this user? This action cannot be undone.</p>
             <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Delete
                </button>
             </div>
        </div>
    </div>


    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // *** IMPORTS MODIFIED ***
        import { 
            getFirestore, collection, getDocs, query, 
            orderBy, limit, startAfter, doc, setDoc, 
            getDoc, deleteDoc, where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoQStCXGXMe5Bz5hk14cOmynRI3gPGs6o",
            authDomain: "kcpttc.firebaseapp.com",
            projectId: "kcpttc",
            storageBucket: "kcpttc.firebasestorage.app",
            messagingSenderId: "709003234625",
            appId: "1:709003234625:web:c9284048369530895065c0",
            measurementId: "G-P1NN0RSNFW"
        };
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : firebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        // --- Initialize Firebase ---
        let app, auth, db;
        let usersCollectionRef;
        try {
            app = initializeApp(finalFirebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Define the path to the users collection
            const usersPath = `artifacts/${appId}/public/data/users`;
            usersCollectionRef = collection(db, usersPath);
        } catch (e) {
            console.error("Firebase initialization error:", e);
            document.getElementById("loading-text").textContent = "Error: Could not connect to Firebase.";
        }

        // --- UI Elements ---
        const loadingContainer = document.getElementById("loading-container");
        const loadingText = document.getElementById("loading-text");
        const reportContainer = document.getElementById("report-container");
        const fetchBtn = document.getElementById("fetch-users-btn");
        const loadMoreBtn = document.getElementById("load-more-btn");
        const downloadCsvBtn = document.getElementById("download-csv-btn");
        const downloadExcelBtn = document.getElementById("download-excel-btn");
        const downloadPdfBtn = document.getElementById("download-pdf-btn");
        const tableBody = document.getElementById("user-table-body");
        const noResults = document.getElementById("no-results");
        const reportStatus = document.getElementById("report-status");

        const filterId = document.getElementById("filter-id");
        const filterName = document.getElementById("filter-name");
        const filterClass = document.getElementById("filter-class");
        
        // --- Modal UI Elements ---
        const userModal = document.getElementById("user-modal");
        const userModalContent = userModal.querySelector(".modal-content");
        const modalTitle = document.getElementById("modal-title");
        const addUserBtn = document.getElementById("add-user-btn");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const cancelModalBtn = document.getElementById("cancel-modal-btn");
        const saveUserBtn = document.getElementById("save-user-btn");
        const userForm = document.getElementById("user-form");
        const modalMessage = document.getElementById("modal-message");

        // Modal Form Fields
        const modalUid = document.getElementById("modal-uid");
        const modalStudentId = document.getElementById("modal-student-id");
        const modalName = document.getElementById("modal-name");
        const modalSex = document.getElementById("modal-sex");
        const modalTel = document.getElementById("modal-tel");
        const modalEmail = document.getElementById("modal-email");
        const modalProgram = document.getElementById("modal-program");
        const modalAcademicYear = document.getElementById("modal-academic-year");
        const modalClass = document.getElementById("modal-class");
        
        // --- Delete Modal UI Elements ---
        const deleteConfirmModal = document.getElementById("delete-confirm-modal");
        const deleteConfirmModalContent = deleteConfirmModal.querySelector(".modal-content");
        const deleteConfirmText = document.getElementById("delete-confirm-text");
        const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
        const confirmDeleteBtn = document.getElementById("confirm-delete-btn");

        // --- App State ---
        let allUsersData = []; // To store all fetched user data
        let lastVisibleDoc = null; // To track pagination
        const USERS_PER_PAGE = 50;
        let currentEditUserId = null; // Track if we are editing or creating
        let currentDeleteUserId = null; // Track which user to delete

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    // Try to sign in with token or anonymously
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Authenticated for reporting.");
                } catch (error) {
                    console.error("Auth error:", error);
                    loadingText.textContent = "Authentication failed. You must be signed in to view reports.";
                    return;
                }
            }
            
            // User is authenticated
            loadingContainer.classList.add("hidden");
            reportContainer.classList.remove("hidden");
        });

        // --- Event Listeners ---
        fetchBtn.addEventListener("click", fetchInitialUsers);
        loadMoreBtn.addEventListener("click", fetchMoreUsers);
        downloadCsvBtn.addEventListener("click", downloadCSV);
        downloadExcelBtn.addEventListener("click", downloadExcel);
        downloadPdfBtn.addEventListener("click", downloadPDF);

        [filterId, filterName, filterClass].forEach(input => {
            input.addEventListener('input', applyFilters);
        });

        // --- Modal Event Listeners ---
        addUserBtn.addEventListener("click", openAddUserModal);
        closeModalBtn.addEventListener("click", closeUserModal);
        cancelModalBtn.addEventListener("click", closeUserModal);
        saveUserBtn.addEventListener("click", handleSaveUser);
        
        // --- Delete Modal Listeners ---
        cancelDeleteBtn.addEventListener("click", closeDeleteModal);
        confirmDeleteBtn.addEventListener("click", handleDeleteUser);

        // --- Main Data Functions ---

        /**
         * Fetches the *first* page of users from the 'users' collection.
         */
        async function fetchInitialUsers() {
            fetchBtn.disabled = true;
            fetchBtn.textContent = "Fetching...";
            reportStatus.textContent = "Loading users from Firestore...";
            noResults.classList.add("hidden");
            loadMoreBtn.classList.add("hidden");
            
            // Clear all old data
            allUsersData = [];
            lastVisibleDoc = null;
            tableBody.innerHTML = "";

            try {
                // Query for the first 50 users, ordered by studentId
                const q = query(usersCollectionRef, 
                                orderBy("studentId"), 
                                limit(USERS_PER_PAGE));
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    noResults.classList.remove("hidden");
                    reportStatus.textContent = "No users found.";
                    hideDownloadButtons();
                    return;
                }

                // Store the last visible document for pagination
                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                allUsersData = querySnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                
                applyFilters(); // Display the data
                showDownloadButtons();
                
                // Show "Load More" button if we got a full page
                if (querySnapshot.size === USERS_PER_PAGE) {
                    loadMoreBtn.classList.remove("hidden");
                }
                
                reportStatus.textContent = `Fetched ${allUsersData.length} users.`;

            } catch (error) {
                console.error("Error fetching users:", error);
                if (error.code === 'failed-precondition') {
                    reportStatus.innerHTML = `<strong>Error:</strong> Firestore index required. Please open the browser console (F12), find the error message, and click the link to create the index.`;
                } else {
                    reportStatus.textContent = `Error fetching users: ${error.message}`;
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = "Fetch Users";
            }
        }

        /**
         * Fetches the *next* page of users.
         */
        async function fetchMoreUsers() {
            if (!lastVisibleDoc) {
                console.log("No more documents to load.");
                loadMoreBtn.classList.add("hidden");
                return;
            }

            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = "Loading...";

            try {
                // Query for the next 50, starting *after* the last one we saw
                const q = query(usersCollectionRef, 
                                orderBy("studentId"), 
                                startAfter(lastVisibleDoc),
                                limit(USERS_PER_PAGE));

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // No more documents found
                    lastVisibleDoc = null;
                    loadMoreBtn.classList.add("hidden");
                    reportStatus.textContent = `All ${allUsersData.length} users loaded.`;
                    return;
                }

                // Update the last visible doc
                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];

                // Add the new reports to our existing data
                const newUsers = querySnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                allUsersData.push(...newUsers);

                // Re-apply filters to the entire (now larger) dataset
                applyFilters();

                // Show "Load More" button if we got another full page
                if (querySnapshot.size < USERS_PER_PAGE) {
                    loadMoreBtn.classList.add("hidden"); // We've reached the end
                    reportStatus.textContent = `All ${allUsersData.length} users loaded.`;
                } else {
                    reportStatus.textContent = `Fetched ${allUsersData.length} total users.`;
                }

            } catch (error) {
                console.error("Error fetching more users:", error);
                reportStatus.textContent = `Error: ${error.message}`;
            } finally {
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = "Load More Users";
            }
        }

        // --- Table and Filter Functions ---

        function applyFilters() {
            const idFilter = filterId.value.toLowerCase();
            const nameFilter = filterName.value.toLowerCase();
            const classFilter = filterClass.value.toLowerCase();

            const filteredData = getFilteredData(idFilter, nameFilter, classFilter);
            populateTable(filteredData);
        }

        function populateTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = "";
                noResults.classList.remove("hidden");
                return;
            }

            noResults.classList.add("hidden");
            let tableHtml = "";

            data.forEach(user => {
                tableHtml += `
                    <tr class="text-sm text-gray-700">
                        <td class="px-4 py-3 font-medium">${escapeHTML(user.studentId || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(user.name || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(user.class || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(user.email || 'N/A')}</td>
                        <td class="px-4 py-3">${escapeHTML(user.telephone || 'N/A')}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button data-id="${escapeHTML(user.docId)}" class="edit-btn text-blue-600 hover:text-blue-800 font-medium mr-3">Edit</button>
                            <button data-id="${escapeHTML(user.docId)}" data-name="${escapeHTML(user.name)}" class="delete-btn text-red-600 hover:text-red-800 font-medium">Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHtml;
            
            // Add event listeners to the new buttons
            tableBody.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditUserModal(btn.dataset.id));
            });
            tableBody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => openDeleteModal(btn.dataset.id, btn.dataset.name));
            });
        }
        
        // --- CRUD Modal Functions ---

        function openAddUserModal() {
            currentEditUserId = null; // Ensure we're in "add" mode
            modalTitle.textContent = "Add New User";
            userForm.reset(); // Clear any old data
            modalUid.value = ""; // Clear UID field
            modalUid.readOnly = false; // Make it editable
            modalUid.classList.remove("bg-gray-200");
            modalUid.classList.add("bg-gray-50");
            
            setModalMessage("", "info");
            openUserModal();
        }

        async function openEditUserModal(userId) {
            currentEditUserId = userId; // Set "edit" mode
            modalTitle.textContent = "Edit User";
            userForm.reset();
            setModalMessage("Loading user data...", "info");
            openUserModal();

            try {
                const user = allUsersData.find(u => u.docId === userId);
                if (!user) throw new Error("User not found in local cache.");

                // Populate the form
                modalUid.value = user.userId || user.docId; // Use userId field, fallback to docId
                modalUid.readOnly = true; // Lock the UID field
                modalUid.classList.add("bg-gray-200");
                modalUid.classList.remove("bg-gray-50");
                
                modalStudentId.value = user.studentId || "";
                modalName.value = user.name || "";
                modalSex.value = user.sex || "";
                modalTel.value = user.telephone || "";
                modalEmail.value = user.email || "";
                modalProgram.value = user.program || "";
                modalAcademicYear.value = user.academicYear || "";
                modalClass.value = user.class || "";

                setModalMessage("", "info"); // Clear loading message

            } catch (error) {
                console.error("Error fetching user for edit:", error);
                setModalMessage(`Error: ${error.message}`, "error");
            }
        }

        function openUserModal() {
            userModal.classList.remove("opacity-0", "pointer-events-none");
            userModalContent.classList.remove("-translate-y-10");
        }

        function closeUserModal() {
            userModal.classList.add("opacity-0", "pointer-events-none");
            userModalContent.classList.add("-translate-y-10");
        }
        
        async function handleSaveUser() {
            saveUserBtn.disabled = true;
            saveUserBtn.textContent = "Saving...";
            
            // 1. Get all data from form
            const userData = {
                studentId: modalStudentId.value.trim(),
                name: modalName.value.trim(),
                sex: modalSex.value,
                telephone: modalTel.value.trim(),
                email: modalEmail.value.trim().toLowerCase(),
                program: modalProgram.value.trim(),
                academicYear: modalAcademicYear.value.trim(),
                class: modalClass.value.trim(),
            };
            
            // 2. Get the User ID
            let userIdToSave = modalUid.value.trim();
            if (currentEditUserId) {
                // In Edit mode, the ID is the document ID
                userIdToSave = currentEditUserId;
            } else if (!userIdToSave) {
                // In Add mode, if UID is blank, generate a random one
                // This is a fallback. Ideally, admin provides the Auth UID
                userIdToSave = crypto.randomUUID();
            }
            
            // 3. Validation
            if (!userData.studentId || !userData.name || !userData.sex || !userIdToSave) {
                setModalMessage("Please fill out all required fields (Student ID, Name, Sex, User ID).", "error");
                saveUserBtn.disabled = false;
                saveUserBtn.textContent = "Save User";
                return;
            }

            try {
                // 4. Check for duplicate Student ID
                const q = query(usersCollectionRef, 
                                where("studentId", "==", userData.studentId));
                const querySnapshot = await getDocs(q);
                
                let isDuplicate = false;
                if (!querySnapshot.empty) {
                    if (currentEditUserId) {
                        // In edit mode, check if the found ID is *different* from the one we are editing
                        isDuplicate = querySnapshot.docs.some(doc => doc.id !== currentEditUserId);
                    } else {
                        // In add mode, any result is a duplicate
                        isDuplicate = true;
                    }
                }

                if (isDuplicate) {
                    throw new Error("This Student ID is already registered to another user.");
                }
                
                // 5. Get the document reference
                const userDocRef = doc(usersCollectionRef, userIdToSave);

                // 6. Add/Update data
                if (currentEditUserId) {
                    // --- UPDATE (Edit Mode) ---
                    await setDoc(userDocRef, userData, { merge: true }); // Use merge to update
                    setModalMessage("User updated successfully!", "success");
                } else {
                    // --- CREATE (Add Mode) ---
                    // Add the UID and timestamp for new users
                    userData.userId = userIdToSave;
                    userData.registeredAt = new Date(); // Use client-side date for admin
                    await setDoc(userDocRef, userData); // Use setDoc to enforce the UID
                    setModalMessage("User created successfully!", "success");
                }

                // 7. Refresh local data and close modal
                await fetchInitialUsers(); // Easiest way to refresh
                setTimeout(closeUserModal, 1500); // Close modal after success

            } catch (error) {
                console.error("Error saving user:", error);
                setModalMessage(`Error: ${error.message}`, "error");
            } finally {
                saveUserBtn.disabled = false;
                saveUserBtn.textContent = "Save User";
            }
        }
        
        // --- Delete Modal Functions ---
        
        function openDeleteModal(userId, userName) {
            currentDeleteUserId = userId;
            deleteConfirmText.innerHTML = `Are you sure you want to delete <strong>${escapeHTML(userName)}</strong> (ID: ${escapeHTML(userId)})? This action cannot be undone.`;
            deleteConfirmModal.classList.remove("opacity-0", "pointer-events-none");
            deleteConfirmModalContent.classList.remove("-translate-y-10");
        }
        
        function closeDeleteModal() {
            currentDeleteUserId = null;
            deleteConfirmModal.classList.add("opacity-0", "pointer-events-none");
            deleteConfirmModalContent.classList.add("-translate-y-10");
        }
        
        async function handleDeleteUser() {
            if (!currentDeleteUserId) return;
            
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = "Deleting...";
            
            try {
                const userDocRef = doc(usersCollectionRef, currentDeleteUserId);
                await deleteDoc(userDocRef);
                
                // Refresh data
                await fetchInitialUsers();
                closeDeleteModal();
                
                // Show a success message
                reportStatus.textContent = `User ${currentDeleteUserId} deleted successfully.`;
                setTimeout(() => { reportStatus.textContent = ""; }, 3000);

            } catch (error) {
                console.error("Error deleting user:", error);
                deleteConfirmText.innerHTML = `Error: ${error.message}`;
            } finally {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = "Delete";
            }
        }
        
        // --- Download/Export Functions ---

        function downloadCSV() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = [
                "Student ID", "Name", "Sex", "Class", "Program", "Academic Year",
                "Email", "Telephone", "User ID", "Registered At"
            ];
            csvContent += headers.join(",") + "\r\n";
            data.forEach(user => {
                const timestamp = user.registeredAt ? (user.registeredAt.toDate ? user.registeredAt.toDate().toISOString() : user.registeredAt) : "";
                const row = [
                    `"${user.studentId || ""}"`, `"${user.name || ""}"`, `"${user.sex || ""}"`,
                    `"${user.class || ""}"`, `"${user.program || ""}"`, `"${user.academicYear || ""}"`,
                    `"${user.email || ""}"`, `"${user.telephone || ""}"`, `"${user.userId || ""}"`,
                    `"${timestamp}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "user_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadExcel() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }
            const worksheetData = data.map(user => ({
                "Student ID": user.studentId || "",
                "Name": user.name || "",
                "Sex": user.sex || "",
                "Class": user.class || "",
                "Program": user.program || "",
                "Academic Year": user.academicYear || "",
                "Email": user.email || "",
                "Telephone": user.telephone || "",
                "User ID": user.userId || "",
                "Registered At": user.registeredAt ? (user.registeredAt.toDate ? user.registeredAt.toDate() : user.registeredAt) : ""
            }));
            const ws = XLSX.utils.json_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "User Report");
            ws["!cols"] = Object.keys(worksheetData[0]).map(key => ({
                wch: Math.max(key.length, ...worksheetData.map(row => String(row[key]).length))
            }));
            XLSX.writeFile(wb, "user_report.xlsx");
        }

        function downloadPDF() {
            const data = getFilteredData();
            if (data.length === 0) {
                alert("No data to download.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });
            const head = [['Student ID', 'Name', 'Class', 'Email', 'Phone']];
            const body = data.map(user => [
                user.studentId || '',
                user.name || '',
                user.class || '',
                user.email || '',
                user.telephone || ''
            ]);
            doc.autoTable({
                head: head,
                body: body,
                startY: 50,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [37, 99, 235] }
            });
            doc.setFontSize(18);
            doc.text("User Report", 40, 35);
            doc.save('user_report.pdf');
        }

        // --- Helper Functions ---

        function getFilteredData(
            idFilter = filterId.value.toLowerCase(),
            nameFilter = filterName.value.toLowerCase(),
            classFilter = filterClass.value.toLowerCase()
        ) {
            return allUsersData.filter(user => {
                const logId = (user.studentId || "").toLowerCase();
                const logName = (user.name || "").toLowerCase();
                const logClass = (user.class || "").toLowerCase();
                return logId.includes(idFilter) &&
                       logName.includes(nameFilter) &&
                       logClass.includes(classFilter);
            });
        }
        
        function escapeHTML(str) {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        function showDownloadButtons() {
            downloadCsvBtn.classList.remove("hidden");
            downloadExcelBtn.classList.remove("hidden");
            downloadPdfBtn.classList.remove("hidden");
        }
        
        function hideDownloadButtons() {
            downloadCsvBtn.classList.add("hidden");
            downloadExcelBtn.classList.add("hidden");
            downloadPdfBtn.classList.add("hidden");
        }
        
        function setModalMessage(message, type = "info") {
            modalMessage.textContent = message;
            if (type === "error") {
                modalMessage.className = "text-sm text-center mt-4 text-red-600";
            } else if (type === "success") {
                modalMessage.className = "text-sm text-center mt-4 text-green-600";
            } else {
                modalMessage.className = "text-sm text-center mt-4 text-blue-600";
            }
        }

    </script>
</body>
</html>